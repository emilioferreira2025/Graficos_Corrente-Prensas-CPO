<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <script src="https://admin.tago.io/dist/custom-widget.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, Helvetica, sans-serif; background: #ffffff; }
    #chart { width: 100%; height: 400px; }
  </style>
</head>

<body>
  <div id="chart"></div>

  <script>
    let chart;

    function renderChart(labels, values) {
      if (!chart) {
        chart = echarts.init(document.getElementById("chart"));
      }

      chart.setOption({
        legend: { show: false },
        tooltip: { trigger: "axis", show: true },
        grid: { left: "8%", right: "5%", top: "8%", bottom: "15%" },
        xAxis: {
          type: "category",
          data: labels,
          axisLabel: { show: false }
        },
        yAxis: {
          type: "value",
          name: "Corrente (A)",
          axisLabel: { formatter: "{value} A" }
        },
        series: [
          {
            type: "line",
            smooth: true,
            showSymbol: true,
            showAllSymbol: false,   // ðŸ”§ evita destacar Ãºltimo ponto automaticamente
            symbol: "circle",
            symbolSize: 5,
            lineStyle: { width: 2, color: "#ff0000" },
            itemStyle: { color: "#ff0000" },
            emphasis: {
              scale: false          // ðŸ”§ remove destaque/zoom no hover
            },
            data: values
          }
        ]
      });
    }

    function applyData(dataArray) {
      const data = dataArray
        .filter(d => d.variable === "current_ipp1")
        .sort((a, b) => new Date(a.time) - new Date(b.time));

      if (!data.length) return;

      const labels = data.map(d => new Date(d.time).toLocaleString("pt-BR"));
      const values = data.map(d => d.value);

      renderChart(labels, values);
    }

    window.TagoIO.onStart(widget => {
      applyData(widget.data);
    });

    window.TagoIO.onRealtime(buckets => {
      let allData = [];
      buckets.forEach(bucket => {
        if (bucket.result) {
          allData = allData.concat(bucket.result);
        }
      });
      applyData(allData);
    });

    window.TagoIO.ready();
  </script>
</body>
</html>
